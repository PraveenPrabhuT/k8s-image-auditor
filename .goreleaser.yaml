project_name: k8s-image-auditor

# 0. PRE-HOOK: Create the dummy file automatically
before:
  hooks:
    # This creates the file GoReleaser needs to "compile"
    - sh -c 'echo "package main; func main() {}" > main.go'

# 1. BUILD: The "Fake" Build
builds:
  - id: k8s-image-auditor
    
    # We force GoReleaser to create artifacts for these targets
    goos:
      - linux
      - darwin
    goarch:
      - amd64
      - arm64

    # We point to the current directory (where main.go now exists)
    main: .
    
    # We name the binary exactly what we want the script to be called
    binary: k8s-image-auditor

    env:
      - CGO_ENABLED=0

    # THE MAGIC: Immediately overwrite the useless Go binary with our Bash script
    hooks:
      post:
        - cp k8s-image-auditor.sh {{ .Path }}

# 2. ARCHIVES: Package the "binary" (which is now our script) + docs
archives:
  - id: default
    format: tar.gz
    name_template: '{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}'
    files:
      - src: Makefile
      - src: k8s-image-auditor.1.md
      - src: completions.bash
      - src: _k8s-image-auditor

checksum:
  name_template: 'checksums.txt'

# 3. HOMEBREW: Update the Tap
brews:
  - name: k8s-image-auditor
    repository:
      owner: PraveenPrabhuT
      name: homebrew-tools
      token: "{{ .Env.GORELEASER_TOKEN }}"
    
    description: "Audits container images for architecture compatibility"
    homepage: "https://github.com/PraveenPrabhuT/k8s-image-auditor"
    license: "MIT"

    # Runtime Dependencies
    dependencies:
      - name: jq
      - name: kubernetes-cli
      - name: skopeo
      - name: awscli
      - name: pandoc # Moved here to fix the previous error

    # The install command that Homebrew will run
    install: |
      system "make", "install", "PREFIX=#{prefix}"
    
    test: |
      assert_match "Usage:", shell_output("#{bin}/k8s-image-auditor -h")